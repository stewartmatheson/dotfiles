local wibox = require("wibox")
local beautiful = require("beautiful")
local volume = require("./volume")
local awful = require("awful")
local gears = require("gears")
local dpi   = require("beautiful.xresources").apply_dpi

local terminal = "alacritty"
local modkey = "Mod4"

local theme_dir = os.getenv("HOME") .. "/.config/awesome/themes/stew-orig"
local theme = {
    font = "ubuntu 14",
    wallpaper = theme_dir .. "/wallpaper.jpg",
    bg_focus = "#00000000",
    widget_vol = theme_dir .. "/icons/vol.png",
    highlight = "#33ccff",
    tilebar_background = "#00000033",
    useless_gap = dpi(20)
}

awful.layout.layouts = { awful.layout.suit.tile }


local function wrap_widget_in_titlebar_container(widget, icon_image_path) 
    return {
        {
            {
                widget,
                wibox.widget.imagebox(icon_image_path),
                layout = wibox.layout.align.horizontal
            },
            bottom = 2,
            color = theme.highlight,
            widget = wibox.container.margin
        },
        left = 0, 
        right = 10,
        layout = wibox.container.margin
    }
end


beautiful.init(theme)

local mytextclock = wibox.widget.textclock()
local volume_module = volume(theme)

local keys = gears.table.join(
    volume_module.keys,
    awful.key({ modkey, }, "Return", function()
        awful.spawn(terminal)
    end)
)

root.keys(keys)

local function set_wallpaper(s)
    -- Wallpaper
    if beautiful.wallpaper then
        local wallpaper = beautiful.wallpaper
        -- If wallpaper is a function, call it with the screen
        if type(wallpaper) == "function" then
            wallpaper = wallpaper(s)
        end
        print(wallpaper)
        gears.wallpaper.maximized(wallpaper, s, true)
    end
end

screen.connect_signal("property::geometry", set_wallpaper)

awful.screen.connect_for_each_screen(function(s) 

    set_wallpaper(s)
    awful.layout.inc(0, s)

    s.mywibox = awful.wibar({ 
		position = "top", 
		screen = s,
        bg = "#00000066",
	})

    s.mytasklist = awful.widget.tasklist {
        screen  = s,
        filter  = awful.widget.tasklist.filter.currenttags,
        buttons = tasklist_buttons
    }

    s.mywibox:setup {
        layout = wibox.layout.align.horizontal,
        { --Left widgets 
        	layout = wibox.layout.align.horizontal,
		},
        s.mytasklist,
        { -- Right widgets
        	layout = wibox.layout.align.horizontal,
            wrap_widget_in_titlebar_container(volume_module.widget, theme.widget_vol),
            wrap_widget_in_titlebar_container(mytextclock)
        },
    }
end)


awful.tag({"Home"})
